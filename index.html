<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Jumper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #container {
            width: 100%;
            height: 100vh;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #canvas {
            width: 80%;
            background-color: #fff;
        }

        /*body{*/
        /*transform: rotate(-90deg);*/
        /*}*/
    </style>
</head>
<body>
<div id="container">
    <canvas id="canvas" width="450" height="800"></canvas>
</div>
</body>
<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const [BASELINE, RECTW, RECTH, DRAGONW, DRAGONH] = [80, 50, 100, 50, 50];
    let speed = 5;

    class Rect {
        constructor() {
            this.x = BASELINE;
            this.y = 900;
            this.w = RECTW;
            this.h = RECTH;
            this.drawRect(this.y)
        }

        init() {
            this.y = 900;
            this.drawRect();
        }

        drawRect() {
            this.y = this.y - speed;
            ctx.fillRect(this.x, this.y, this.h, this.w);
            if (this.y < -100) {
                this.y = Math.floor(900 * (1 + Math.random() * Math.random() * Math.random()));
                console.log(this.y);
                ctx.fillRect(this.x, this.y, this.h, this.w);
            }
        }

    }

    class Dragon {
        constructor() {
            this.x = BASELINE;
            this.y = 100;
            this.w = DRAGONW;
            this.h = DRAGONH;
            this.isTop = false;
            this.jumping = false;
            this.drawDragon()
        }

        init() {
            this.x = BASELINE;
            this.y = 100;
            this.isTop = false;
            this.jumping = false;
            this.drawDragon();
        }

        clearRect() {
            ctx.clearRect(BASELINE, 0, 450 - BASELINE, 800);
            if (this.x === BASELINE) {
                ctx.strokeRect(BASELINE, 100, DRAGONW, DRAGONH);
            }
        };

        jump() {
            this.jumping = true;
        }

        drawDragon() {
            if (this.jumping) {
                if (!this.isTop) {
                    if (this.x < RECTH + DRAGONH + 80) {
                        if (this.x > 225) {
                            ctx.strokeRect(this.x = this.x + 1, 100, DRAGONW, DRAGONH);
                        } else if (this.x > 215) {
                            ctx.strokeRect(this.x = this.x + 2, 100, DRAGONW, DRAGONH);
                        } else if (this.x > 190) {
                            ctx.strokeRect(this.x = this.x + 3, 100, DRAGONW, DRAGONH);
                        } else {
                            ctx.strokeRect(this.x = this.x + 6, 100, DRAGONW, DRAGONH);
                        }
                    } else {
                        ctx.strokeRect(this.x, 100, DRAGONW, DRAGONH);
                        this.isTop = true;
                    }
                } else {
                    if (this.x > BASELINE) {
                        if (this.x > 225) {
                            ctx.strokeRect(this.x = this.x - 1, 100, DRAGONW, DRAGONH);
                        } else if (this.x > 215) {
                            ctx.strokeRect(this.x = this.x - 2, 100, DRAGONW, DRAGONH);
                        } else if (this.x > 190) {
                            ctx.strokeRect(this.x = this.x - 3, 100, DRAGONW, DRAGONH);
                        } else {
                            ctx.strokeRect(this.x = this.x - 6, 100, DRAGONW, DRAGONH);
                        }
                    } else {
                        ctx.strokeRect(this.x, 100, DRAGONW, DRAGONH);
                        this.isTop = false;
                        this.jumping = false;
                    }
                }
                ctx.beginPath();
                ctx.moveTo(BASELINE + 15, 100);
                ctx.lineTo(BASELINE + 15, 150);
                ctx.stroke();
            } else {
                ctx.strokeRect(this.x, 100, DRAGONW, DRAGONH);
            }
            ctx.clearRect(this.x, 100, DRAGONW - 1, DRAGONH - 1);
        }
    }

    class Cloud {
        constructor(y) {
            this.x = 250 * (1 + Math.random() * Math.random());
            this.y = 800 * Math.random();
            this.w = 100;
            this.h = 20;
            this.speed = Math.floor(1 + 2 * Math.random());
            this.drawCloud()
        }

        init() {
            this.y = 800 * Math.random();
            this.drawCloud();
        }

        drawCloud() {
            this.y = this.y - this.speed;
            ctx.save();
            ctx.fillStyle = "#cccccc";
            ctx.fillRect(this.x, this.y, this.h, this.w);
            if (this.y < -100) {
                this.speed = Math.ceil(5 * Math.random());
                this.x = 250 * (1 + Math.random() * Math.random());
                this.y = Math.floor(800 * (1 + Math.random() * Math.random() * Math.random()));
                console.log(this.y);
                ctx.fillRect(this.x, this.y, this.h, this.w);
            }
            ctx.restore();
        }
    }

    class Game {
        constructor() {
            this.status = "pause";
            this.lose = false;
            this.score = 0;
            this.drawLine();
            this.drawText("点击屏幕开始游戏", "center");
            this.drawText("00000", "RT");
            this.dragon = new Dragon();
            this.rect = new Rect();
            this.cloud1 = new Cloud();
            this.cloud2 = new Cloud();
            this.cloud3 = new Cloud();
            this.cloud4 = new Cloud();
            canvas.onclick = function () {
                if (this.status === "pause") {
                    this.status = "playing";
                    this.animationFrame();
                } else {
                    this.dragon.jump();
                }
                if (this.lose) {
                    this.init();
                }
            }.bind(this);
        }

        setScore() {
            this.score += 1;
            if (this.score % 1000 === 0) {
                speed += 1;
            }
            let showScore = Math.ceil(this.score / 10);
            if (showScore < 10000) {
                if (showScore >= 1000) {
                    showScore = "0" + showScore;
                } else if (showScore >= 100) {
                    showScore = "00" + showScore;
                } else if (showScore >= 10) {
                    showScore = "000" + showScore;
                } else {
                    showScore = "0000" + showScore;
                }
            }
            if (Math.ceil(this.score / 10) % 100 === 0) {
                this.drawText(showScore, "RT", 30, "red")
            } else {
                this.drawText(showScore, "RT", 30)
            }

        }

        init() {
            this.status = "pause";
            this.lose = false;
            this.score = 0;
            speed = 5;
            ctx.clearRect(0, 0, 450, 800);
            this.drawText("点击屏幕开始游戏", "center");
            this.drawText("00000", "RT");
            this.drawLine();
            this.rect.init();
            this.dragon.init();
            this.cloud1.drawCloud();
            this.cloud2.drawCloud();
            this.cloud3.drawCloud();
            this.cloud4.drawCloud();
        }

        drawText(text, pos, fntSize = 30, color = "#000") {
            ctx.save();
            ctx.fillStyle = color;
            ctx.font = fntSize + "px Arial";
            if (pos === "center") {
                ctx.translate(225, 400 - text.length * fntSize / 2);
            } else if (pos === "RT") {
                ctx.translate(380, 680);
            }
            ctx.rotate(90 * Math.PI / 180);
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }

        drawLine() {
            ctx.beginPath();
            ctx.moveTo(BASELINE + 15, 0);
            ctx.lineTo(BASELINE + 15, 800);
            ctx.stroke();
        };

        clearRect() {
            ctx.clearRect(BASELINE + 15, 0, 450 - BASELINE, 800);
            ctx.clearRect(0, 0, BASELINE + 14, 800);
        };

        check() {
            let yDisB = this.rect.y - this.dragon.y - this.dragon.w;
            let xDisB = this.dragon.x - this.rect.h - this.rect.x;
            let yDisA = this.dragon.y - this.rect.y - this.rect.w;
            if (!(yDisB >= 0 || xDisB >= 0 || yDisA >= 0)) {
                this.status = "pause";
                this.lose = true;
                this.drawText("游戏结束,点击屏幕重新开始", "center");
            }
        }

        animationFrame() {
            this.clearRect();
            this.rect.drawRect();
            this.cloud1.drawCloud();
            this.cloud2.drawCloud();
            this.cloud3.drawCloud();
            this.cloud4.drawCloud();
            this.dragon.drawDragon();
            this.check();
            this.setScore();
            if (this.status === "pause") {
                return;
            }
            requestAnimationFrame(this.animationFrame.bind(this))

        }
    }

    new Game();
</script>
</html>
